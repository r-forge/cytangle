---
title: "Cytangle: Understanding and Interpreting TDA"
author: "Kevin R. Coombes"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: yeti
    highlight: kate
---
  
```{r setup, include=FALSE, results="hide"}
knitr::opts_chunk$set(echo = TRUE)
```
```{r mycss, results="asis", echo=FALSE}
cat('
<style type="text/css">
b, strong {color: red; }
i, em {color: blue; }
.defn {color: purple; }
.para {color: purple;
      font-weight: bold;
}
.figure { text-align: center; }
.caption { font-weight: bold; }
</style>
')
```

# Overview
We are preparing CyTOF (mass cytometry) data from Greg Behbehani for analysis.
There are two parallel experiments from the same original set of samples, which
consists of bone marrow cells from patients
with acute myeloid leukemia (AML) or from normal controls. Experiment A studies
cell cycle proteins while experiment B studies B-cell receptor signaling
proteins. Both experiments use the same set of cell surface markers to identify
the individual type of white cells present in the data.

The goal of this report is to intepret the results of the
(computationally intensive and time consuming) topological data
analysis from the previous report `x09`.

# Getting Started
Start by defining the default paths.
```{r paths}
source("r00-paths.R")
```
Load some useful packages.
```{r libs}
library(beanplot)
library(Polychrome)
```
Next, load the collated results of the TDA. These came in two parts.
```{r collate}
load(file.path(paths$scratch, "collate.Rda"))
temp <- collate
load(file.path(paths$scratch, "collate1d.Rda"))
dim(temp)
dim(collate)
collate <- rbind(collate, temp)
save(collate, file = file.path(paths$scratch, "recollate.Rda"))
```

# First Looks
We take a first peek at the collated data.
```{r peek}
dim(collate)
summary(collate)
table(collate$Dimension)
```
We have almost 550,000 potential "topological events" (TE); however, we expect
most of them to be noise. The vast majority are zero-dimensional, which translates
mathematically as "connected components" and biologically as "clusters". We really
don't think that any of those are interesting in this context. The one-dimensional
TEs are potential "loops" or topological circles. The two-dimensional TEs are "voids"
or topological spheres. Ahy of these that look real are going to be worth exploring
in detail.

```{r byDimAndTube}
attach(collate)
table(Tube, Dimension)
detach()
```
It is interesting that there are more potential TEs over every dimension in Tube B
(the BCR Signaling experiment) than in Tube A (the cell cycle experiment). That may,
hoever, be a consequence of having more sample-node pairs with large enough principal
component (PC) dimension.

# Visualization
Here are some summary statistics (specifically, quantiles) for the tails of the
durations, by topological dimension. It is pretty clear that they differ dramatically
from one dimension to another.
```{r}
attach(collate)
quantile(Duration[Dimension == 2], c(0.95, 0.975, 0.99, 0.999))
quantile(Duration[Dimension == 1], c(0.95, 0.975, 0.99, 0.999))
quantile(Duration[Dimension == 0], c(0.95, 0.975, 0.99, 0.999))
detach()
```

Here we use box plots and bean plots (also called violin plots) to get a rough
idea of the distribution of duration by dimension. This shows that it is not
only the tails but the bulk of the data that differs by dimension.
```{r fid.width=12, fig.height=6, fig.cap="Distribuion of duration, by dimension of event."}
data(colorsafe)
tricol <- colorsafe[1:3]
opar <- par(mfrow=c(1,2))
attach(collate)
boxplot(Duration ~ Dimension, col=tricol)
beanplot(Duration ~ Dimension, what=c(1, 1, 1, 0), col=as.list(tricol),
         ylab="Log Duration", xlab="Dimension")
detach()
```

Now we plot hisotgrams to get a clearer picture of the distribution.
```{r fig.width=12, fig.height=10, fig.cap="Histograms of duration."}
opar <- par(mfrow=c(2,2))
attach(collate)
hist(Duration, breaks=234, col=colorsafe[4])
hist(Duration[Dimension == 0], breaks=234, col=colorsafe[4])
hist(Duration[Dimension == 1], breaks=234, col=colorsafe[4])
hist(Duration[Dimension == 2], breaks=234, col=colorsafe[4])
detach()
par(opar)
```
The pooled data looks complex, but that is because (1) it is a mixture of three
very different distributions, and (2) the parmaeter to the TDA analysis that set
the maximum duration to 5 clearly caused substantial truncation in the
zero-dimensional case. The most intersting fact, however, may be that the shape
in dimension0 (normal-ish; maybe a gamma) is different from dimensions one and
two (which look simply exponential).

```{r eval=FALSE, echo=FALSE}
attach(collate)
wm2 <- which.max(duration[dimension==2 & PCDim > 2])
samnode[dimension==2 & PCDim > 2][wm2]
duration[dimension==2 & PCDim > 2][wm2]

wm <- which.max(duration[dimension==1 & PCDim > 1])
samnode[dimension==1 & PCDim > 1][wm]
duration[dimension==1 & PCDim > 1][wm]



ww <- which(duration[dimension==2] > 0.37)
collate[dimension==2,][ww,]
detach() # collate

temp <- (collate$dimension == 2 & collate$duration > 0.25 &
           collate$Tube == "B" & samname == "CR6" )
summary(collate[temp,])

ripDir <- file.path(paths$scratch, "rip")
source("voidPlot.R")

rgl.open();
rgl.close(); voidPlot("A", "AML38", "node42")
rgl.close(); voidPlot("A", "CR6",   "node51")
rgl.close(); voidPlot("A", "AML35", "node60")
rgl.close(); voidPlot("A", "AML21", "node69")
rgl.close(); voidPlot("A", "AML21", "node102")
rgl.close(); voidPlot("A", "CR5",   "node102")
rgl.close(); voidPlot("A", "AML38", "node112")
rgl.close(); voidPlot("A", "AML41", "node122")
rgl.close(); voidPlot("B", "Nl-6_x2", "node35")
rgl.close(); voidPlot("B", "CR6",   "node51")
rgl.close(); voidPlot("B", "AML4",  "node61")
rgl.close(); voidPlot("B", "AML30", "node62")
rgl.close(); voidPlot("B", "AML33", "node67")
rgl.close(); voidPlot("B", "AML9",  "node79")
rgl.close(); voidPlot("B", "AML15", "node102")


if (FALSE) {
library(scatterplot3d)
val <- scatterplot3d(usable, color='gray', pch=16)
for (J in 1:10) {
  val$points3d(cyc[J,,], col='red', type='p', pch=16)
  val$points3d(cyc[J,,], col='red', type='l', lwd=2)
}
}
```

# Appendix
These computations were performed in the following environment:
```{r si}
sessionInfo()
```
and in the following directory:
```{r where}
getwd()
```

