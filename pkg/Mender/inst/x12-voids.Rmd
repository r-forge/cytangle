---
title: "Cytangle: Testing Significance of TDA"
author: "Kevin R. Coombes"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: yeti
    highlight: kate
---
  
```{r setup, include=FALSE, results="hide"}
knitr::opts_chunk$set(echo = TRUE)
```
```{r mycss, results="asis", echo=FALSE}
cat('
<style type="text/css">
b, strong {color: red; }
i, em {color: blue; }
.defn {color: purple; }
.para {color: purple;
      font-weight: bold;
}
.figure { text-align: center; }
.caption { font-weight: bold; }
</style>
')
```

# Overview
We are preparing CyTOF (mass cytometry) data from Greg Behbehani for analysis.
There are two parallel experiments from the same original set of samples, which
consists of bone marrow cells from patients
with acute myeloid leukemia (AML) or from normal controls. Experiment A studies
cell cycle proteins while experiment B studies B-cell receptor signaling
proteins. Both experiments use the same set of cell surface markers to identify
the individual type of white cells present in the data.

The goal of this report is to examine the node-sample combinations
with significant "voids" (topologically spherical holes).

# Getting Started
Start by defining the default paths.
```{r paths}
source("r00-paths.R")
### set default paths
ripDir <- file.path(paths$scratch, "rip")
```
Load some useful packages.
```{r libs}
library(Polychrome)
library(ClassDiscovery)
library(rgl)
```
Read the source code for a few utility funcions.
```{r util}
source("u01-justOverlay.R")
source("voidplot.R")
```
Finally, load the collated results of the TDA.
```{r collate}
load(file.path(paths$scratch, "recollate.Rda"))
```
Now extract the subset (from `collate`) that contains node-sample pairs
with significant voids. The cutoff is based on work presented in the
previous report (`x10`).
```{r siggVoid}
sigVoid <- collate[collate$Dimension == 2 & 
                     collate$Duration > 0.33,]
sigVoid$Sample <- factor(sigVoid$Sample)
sigVoid$Node <- factor(sigVoid$Node)
summary(sigVoid)
dim(sigVoid)
```

Set up to plot igraphs.
```{r setupIgraph}
mst <- read_graph(file.path(paths$root, "SPADE", "mst.gml"), format="gml")
mst <- set_vertex_attr(mst, "size", value=3)   # shrink the nodes
mst <- set_vertex_attr(mst, "label", value="") # hide the labels

```

```{r iso}
load(file.path(paths$clean, "isotopes.Rda"))
load(file.path(paths$scratch, "pcdimA.Rda"))
load(file.path(paths$scratch, "pcdimB.Rda"))
```

Set a color palette.
```{r pal}
lt <- light.colors()
pal <- c("white", lt[c("NC7", "NC18", "NC3", "NC12")])
rm(lt)
```

Set up directories.
```{r figDir}
figDir <- file.path(ripDir, "voidFigs")
if (!file.exists(figDir)) dir.create(figDir)
aDir <- file.path(figDir, "A")
if (!file.exists(aDir)) dir.create(aDir)
bDir <- file.path(figDir, "B")
if (!file.exists(bDir)) dir.create(bDir)
rm(aDir, bDir)

htmlDir <- file.path(paths$results, "HTML")
if (!file.exists(htmlDir)) dir.create(htmlDir)
aDir <- file.path(htmlDir, "A")
if (!file.exists(aDir)) dir.create(aDir)
bDir <- file.path(htmlDir, "B")
if (!file.exists(bDir)) dir.create(bDir)
rm(aDir, bDir)
```

```{r makePNGs}
rgl.open()
etype <- list(A = "Cell Cycle", B = "BCR Signaling")
R <- 300
pp <- dget("myview.R")
# I <- which(sigVoid$Sample == "AML22" & sigVoid$Node == "node81")
for (I in 1:nrow(sigVoid)) {
  b <- sigVoid[I, "Tube"]
  s <- sigVoid[I, "Sample"]
  n <- sigVoid[I, "Node"]
  flag <- paste(s, ", ", n,
                ", Tube ", b, " (", etype[[b]], ")",
                sep='')
  
  ## 2d igraph plot showing node location
  ns <- as.numeric(sub("node", "", as.character(sigVoid$Node[I])))
  baffle <- rep(3, 483)
  baffle[as.numeric(sub("node", "", n))] <- 6
  ## resize the nodes
  mst <- set_vertex_attr(mst, "size", value=baffle)
  ## set the color scheme
  pb <- pcdimB[, as.character(s)]
  pb[is.na(pb)] <- 0
  pb[pb > 3] <- 4
  mycols <- pal[1+pb]
  ## color the nodes by trujncated PC dimension
  mstN <- set_vertex_attr(mst, "color", value=mycols)
  ## make the plot
  iname <- file.path(figDir, b, 
                     paste(s, n, b, "igraph.png", sep="-"))
  png(file = iname, width=9*R, height=10.3*R, res=R, bg="white")
  layout(matrix(1:2, ncol=1), 1, c(9, 1.3))
  opar <- par(mai=c(0.2, 0.2, 1.2, 0.2), bg="white")

  plot(mstN, layout=lay, 
       main=flag)
  overlay()
  par(mai=c(1, 3, 0.03, 3))
  image(1:4, 1:1, matrix(1:4, ncol=1), col=pal[2:5],
        xlab="", ylab="", yaxt="n")
  mtext("Dimension", side=2, line=1, las=2)
  par(opar)
  dev.off()
}
```

```{r makeRGLs}
rgl.open()
etype <- list(A = "Cell Cycle", B = "BCR Signaling")
# I <- which(sigVoid$Sample == "AML22" & sigVoid$Node == "node81")
for (I in 1:nrow(sigVoid)) {
  b <- sigVoid[I, "Tube"]
  s <- sigVoid[I, "Sample"]
  n <- sigVoid[I, "Node"]
  flag <- paste(s, ", ", n,
                ", Tube ", b, " (", etype[[b]], ")",
                sep='')
  ## 3d plot showing the void
  while(rgl.cur()) rgl.close();
  voidPlot(b, s, n)
  title3d(main=flag, 
          xlab="X", ylab="Y", zlab="Z", col='purple')
  vdir <- file.path(htmlDir, b)
  vname <- file.path(vdir, paste(s, n, b, "void.html", sep="-"))
  writeWebGL(vdir, vname)
}
```

# Appendix
These computations were performed in the following environment:
```{r si}
sessionInfo()
```
and in the following directory:
```{r where}
getwd()
```

