---
title: "Cytangle: Studying 'Complete Recovery' Sample CR6"
author: "Kevin R. Coombes"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: yeti
    highlight: kate
---
  
```{r setup, include=FALSE, results="hide"}
knitr::opts_chunk$set(echo = TRUE)
```
```{r mycss, results="asis", echo=FALSE}
cat('
<style type="text/css">
b, strong {color: red; }
i, em {color: blue; }
.defn {color: purple; }
.para {color: purple;
      font-weight: bold;
}
.figure { text-align: center; }
.caption { font-weight: bold; }
</style>
')
```

# Overview
We are preparing CyTOF (mass cytometry) data from Greg Behbehani for analysis.
There are two parallel experiments from the same original set of samples, which
consists of bone marrow cells from patients
with acute myeloid leukemia (AML) or from normal controls. Experiment A studies
cell cycle proteins while experiment B studies B-cell receptor signaling
proteins. Both experiments use the same set of cell surface markers to identify
the individual type of white cells present in the data.

# Getting Started
Start by defining the default paths.
```{r paths}
source("r00-paths.R")
```
Now get the basic information about the experiment.
```{r basics}
load(file.path(paths$clean, "isotopes.Rda"))
load(file.path(paths$clean, "groups.Rda"))
```
Now get data for the Tube A cell cycle proteins.
```{r tubeA}
load(file.path(paths$clean, "cellCountsA.Rda"))
```

Next, we source the 'nodeMeans' and  'overlay' functions.
```{r overlay}
source("u01-justOverlay.R")
source("u02-nodeMeans.R")
```

# Selecting two B-cell populations
We want to make sure that we know which node IDs are mapped into the early
and mature B-cell sets. So, we set up the (i)graph view of the data.
```{r setupgraph}
mst <- read_graph(file.path(paths$spade, "mst.gml"), format="gml")
mst <- set_vertex_attr(mst, "size", value=3)   # shrink the nodes
mst <- set_vertex_attr(mst, "label", value="") # hide the labels
```

We then use the layout data to try to locate the eraly B cells.
```{r earlyB}
start <- 21
lay[start,]
temp <- apply(sweep(lay, 2, lay[start,], "-")^2, 1, sum)
cutoff <- sort(temp)[8]
earlyBs <- temp < cutoff
which(earlyBs)
```

Similarly, we try to get the mature B cells, though this try includes
a few extras.
```{r matureBplus}
start <- 101
lay[start,]
temp <- apply(sweep(lay, 2, lay[start,], "-")^2, 1, sum)
cutoff <- sort(temp)[23]
matureBs <- temp < cutoff
which(matureBs)
```
So, we manually get rid of the excess.
```{r matureB}
matureBs[107] <- FALSE
matureBs[earlyBs] <- FALSE
which(matureBs)
```
Now we assign colors and look at the SPADE plot to confirm our findings.
```{r showBs, fig.width=9, fig.height=9, fig.cap="B cell populations."}
foocols <- rep("gray", 483)
foocols[earlyBs] <- "pink"
foocols[matureBs] <- "skyblue"

mstCheck <- set_vertex_attr(mst, "color", value=foocols) #
plot(mstCheck, layout=lay)
overlay()
```

# CR6
Here we look at one of the "complete recovery" AML samples, CR6. The first step
is to get the node data for this sample.
```{r CR}
nms <- "CR6"
cr6 <- nodeMeans(nms, "A")
```
We are particularly interested in the proliferation marker, Ki-67.
```{r ki67}
CR6 <- cr6[, "Ki-67"]
N <- min(CR6, na.rm=TRUE)
D <- median(CR6, na.rm=TRUE)
M <- 2*D - N
trunc <- CR6
trunc[CR6 > M] <- M
nch <- cut(trunc, breaks=seq(N, M, length=64), labels=FALSE, include.lowest=TRUE)
summary(nch)
```
We plot the raw data.
```{r fig.width=6, fig.height=6, fig.cap="Log cell counts by Ki-67 expression for CR6." }
cc <- cellCountsA[,"CR6"]
nc <- log10(1 + cc)
plot(CR6, nc, pch=16, ylab="Log10 Cell Counts", xlab="Ki-67 expression")
```
A histogram of Ki8-67 expression suggests that there are two modes (which
might mean some nodes are proliferating and others are quiescent).
```{r fig.cap="Histogram of Ki-67 expression in CR6 nodes."}
hist(CR6, breaks=45) # breakpoint around 2?
```

```{r fig.cap="Quantized rank."}
bot <- 2
top <- 3
plot(nch, nc, pch=16, xlab="Quantized Rank Expression", ylab="Log10 Cell Counts")
abline(h=c(bot, top), v=c(15, 45))
quiescent <- (bot < nc & nc < top & CR6 < D)  # CD34+
which(quiescent & matureBs)
active    <- (bot < nc & nc < top & CR6 > D)   # ???
which(active & earlyBs)
```

## Two selected nodes
The next SPADE plot shows nodes of interest.
```{r fig.width=9, fig.height=9, fig.cap="SPADE plot showing particularly active (orange) and quiet (blue) nodes in CR6."}
sz <- rep(2, 483)
sz[quiescent] <- 4
sz[active] <- 4
crp <- colorRampPalette(c("#0000ff", "gray80", "#ff8c00"))(64)
mstC <- set_vertex_attr(mst, "color", value=crp[nch])
mstC <- set_vertex_attr(mstC, "size", value=sz)   # shrink the nodes
plot(mstC, layout=lay)
overlay()
```

```{r nodesOfInterest}
sz <- rep(3, 483)
picked <- c(early=108, mature=7)
sz[picked] <- 6
save(picked, file = file.path(paths$scratch, "pickedNodes.Rda"))
mstC <- set_vertex_attr(mstC, "size", value=sz)   # shrink the nodes
fout <- file.path(paths$R01figs,"cr6-ki67.png")
resn <- 120
png(file=fout, width=9*resn, height=10.3*resn, res=resn, bg="white")
layout(matrix(1:2, ncol=1), 1, c(9,1.3))
opar <- par(mai=c(0.2, 0.2, 1.2, 0.2), bg="white")
plot(mstC, layout=lay, main="CR6; KI67")
overlay()
par(mai=c(1, 3, 0.01, 3))
arf <- seq(min(trunc, na.rm=TRUE), max(trunc, na.rm=TRUE), length=64)
image(arf, 1:1, matrix(1:64, ncol=1), col=crp,
      xlab="Log Expression", ylab="", yaxt="n")
par(opar)
par(mfrow=c(1,1))
dev.off()
```

![SPADE plot of log expression of Ki-67 in CR6, highlighting two nodes of interest.](`r fout`)

# Topological Data Analysis (TDA)
We load some additional libraries.
```{r libs}
library(ClassDiscovery)
library(Polychrome)
p34 <- palette36.colors(36)[3:36]

if (!require("TDA")) {
  dev.off()
  install.packages("TDA")
  library(TDA)
}
```

We (mostly manually) pick out a bunch of points at which we want to perfomr TDA.
```{r tdaNodes}
size <- function(x) ifelse(is.matrix(x), nrow(x), 1)

mNodes <- which(quiescent & matureBs)
eNodes <- which(active & earlyBs)
oNodes <- which(active & !earlyBs)

manual <- c(9, 21, 46, 56, 62, 95, 118, 127, 140, 178, 199,
            218, 220, 248, 258, 297, 312, 343, 379, 386,
            390, 424, 430, 431, 436, 465)

manual <- c(eNodes, mNodes, 297, oNodes[1:18])

tcol <- rep(NA, 483)
tcol[eNodes] <- "#00ffff"
tcol[mNodes] <- "#ffff00"
tcol[c(297, oNodes)] <- "#ff00ff"
```

```{r fig.width=12, fig.height=12, fig.cap="Nodes for TDA."}
labels <- 1:483
#labels[!active & !(quiescent & matureBs)] <- ""
labels <- rep("", 483)
labels[manual] <- manual
mstX <- set_vertex_attr(mst, "label", value = labels) # hide some labels
mstX <- set_vertex_attr(mstX, "size", value = 5)  # grow the nodes
mstX <- set_vertex_attr(mstX, "color", value = tcol)  # white
plot(mstX, layout=lay)
overlay()
```

## Early B-cell Nodes
We run TDA on the nodes from early B-cell populations.
```{r tdaEarly}
delta <- 0.5
early <- file.path(paths$scratch, "Early")
earlyFigs <- file.path(paths$R01figs, "EarlyFigs")
if(!file.exists(early)) dir.create(early)
if(!file.exists(earlyFigs)) dir.create(earlyFigs)
for (nd in eNodes) {
  label <- paste(nms, "; Node", nd, "; Early B Cells")
  nodefile <- paste("node", nd, ".Rda", sep='')
  load(file.path(paths$cluster, "A", nms, nodefile))
  cat("Working on '", nms, "' with", size(tempMat), "cells.\n", file=stderr()) 
  M <- tempMat[, Atarget]
  spcaM <- SamplePCA(t(M))
  usable <- spcaM@scores[, 1:2]
  fname <- paste(nms, "Node", nd, "rips.Rda", sep='-')
  if (file.exists(file = file.path(early, fname))) {
    next
  }
  rips <- ripsDiag(usable, 1, 5, library="Dionysus", location=TRUE)
  save(rips, file=file.path(early, fname))
  png(file=file.path(earlyFigs, sub("Rda", "png", fname)),
      width=640, height=640, bg="white")
  plot(rips[["diagram"]], barcode=TRUE, main=label)
  dev.off()
  png(file=file.path(earlyFigs, sub(".Rda", "-cyc.png", fname)),
      width=640, height=640, bg="white")
  rd <- rips[["diagram"]]
  oneD <- rd[,1] == 1 # first col of rd is 'dimension'
  cyc <- rips$cycleLocation[oneD]
  duration <- (rd[,3] - rd[,2])[oneD]
  target <- max(duration)
  plot(spcaM, main=label)
  for (j in 1:length(cyc)) {
    c19 <- cyc[[j]]
    if (prod(dim(c19)) == 0) next
    if (duration[j] < min(delta, target)) next
    colj <- ifelse(duration[j] == target,
                   ifelse(delta > target, p34[2], p34[1]),
                   "gray60")
    for(i in 1:dim(c19)[1]) {
      lines(c19[i,,1],c19[i,,2], col=colj, lwd=2)
    }
  }
  dev.off()  
}
```

## Mature B-cell Nodes

```{r tdaMature}
mature <- file.path(paths$scratch, "Mature")
matureFigs <- file.path(paths$R01figs, "MatureFigs")
if(!file.exists(mature)) dir.create(mature)
if(!file.exists(matureFigs)) dir.create(matureFigs)
for (nd in mNodes) {
  label <- paste(nms, "; Node", nd, "; Mature B Cells")
  nodefile <- paste("node", nd, ".Rda", sep='')
  load(file.path(paths$cluster, "A", nms, nodefile))
  cat("Working on '", nms, "' with", size(tempMat), "cells.\n", file=stderr()) 
  M <- tempMat[, Atarget]
  spcaM <- SamplePCA(t(M))
  usable <- spcaM@scores[, 1:2]
  fname <- paste(nms, "Node", nd, "rips.Rda", sep='-')
  if (file.exists(file=file.path(mature, fname))) {
    next
  }
  rips <- ripsDiag(usable, 1, 5, library="Dionysus", location=TRUE)
  save(rips, file=file.path(mature, fname))
  png(file=file.path(matureFigs, sub("Rda", "png", fname)),
      width=640, height=640, bg="white")
  plot(rips[["diagram"]], barcode=TRUE, main=label)
  dev.off()
  png(file=file.path(matureFigs, sub(".Rda", "-cyc.png", fname)),
      width=640, height=640, bg="white")
  rd <- rips[["diagram"]]
  oneD <- rd[,1] == 1 # first col of rd is 'dimension'
  cyc <- rips$cycleLocation[oneD]
  duration <- (rd[,3] - rd[,2])[oneD]
  target <- max(duration)
  plot(spcaM, main=label)
  for (j in 1:length(cyc)) {
    c19 <- cyc[[j]]
    if (prod(dim(c19)) == 0) next
    if (duration[j] < min(delta, target)) next
    colj <- ifelse(duration[j] == target,
                   ifelse(delta > target, p34[2], p34[1]),
                   "gray60")
    for(i in 1:dim(c19)[1]) {
      lines(c19[i,,1],c19[i,,2], col=colj, lwd=2)
    }
  }
  dev.off()  
}
```

## Other Nodes
```{r tdaOther}
oNodes <- c(297, oNodes)[1:19] # arbitrary stopping point
other <- file.path(paths$scratch, "Other")
otherFigs <- file.path(paths$R01figs, "OtherFigs")
if(!file.exists(other)) dir.create(other)
if(!file.exists(otherFigs)) dir.create(otherFigs)
for (nd in oNodes) {
  label <- paste(nms, "; Node", nd, "; Other Cells")
  nodefile <- paste("node", nd, ".Rda", sep='')
  load(file.path(paths$cluster, "A", nms, nodefile))
  cat("Working on '", nms, "' with", size(tempMat), "cells.\n", file=stderr()) 
  M <- tempMat[, Atarget]
  spcaM <- SamplePCA(t(M))
  usable <- spcaM@scores[, 1:2]
  fname <- paste(nms, "Node", nd, "rips.Rda", sep='-')
  if (file.exists(file=file.path(other, fname))) {
    next
  }
  rips <- ripsDiag(usable, 1, 5, library="Dionysus", location=TRUE)
  save(rips, file=file.path(other, fname))
  png(file=file.path(otherFigs, sub("Rda", "png", fname)),
      width=640, height=640, bg="white")
  plot(rips[["diagram"]], barcode=TRUE, main=label)
  dev.off()
  png(file=file.path(otherFigs, sub(".Rda", "-cyc.png", fname)),
      width=640, height=640, bg="white")
  rd <- rips[["diagram"]]
  oneD <- rd[,1] == 1 # first col of rd is 'dimension'
  cyc <- rips$cycleLocation[oneD]
  duration <- (rd[,3] - rd[,2])[oneD]
  target <- max(duration)
  plot(spcaM, main=label)
  for (j in 1:length(cyc)) {
    c19 <- cyc[[j]]
    if (prod(dim(c19)) == 0) next
    if (duration[j] < min(delta, target)) next
    colj <- ifelse(duration[j] == target,
                   ifelse(delta > target, p34[2], p34[1]),
                   "gray60")
    for(i in 1:dim(c19)[1]) {
      lines(c19[i,,1],c19[i,,2], col=colj, lwd=2)
    }
  }
  dev.off()  
}
```

# Appendix
These computations were performed in the following environment:
```{r si}
sessionInfo()
```
and in the following directory:
```{r where}
getwd()
```

